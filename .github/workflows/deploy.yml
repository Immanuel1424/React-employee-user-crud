name: Deploy Fullstack App

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🔐 Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: 📌 Add EC2 IP to known_hosts
        run: ssh-keyscan -H ${{ secrets.PUBLIC_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: 🧪 Test SSH access to EC2
        run: ssh -o StrictHostKeyChecking=yes ubuntu@${{ secrets.PUBLIC_INSTANCE_IP }} "echo '✅ Public instance connected!'"

      - name: 📦 Build and archive code
        run: |
          mkdir -p /tmp/fullstack-build
          tar --exclude='.git' --exclude='fullstack.tar.gz' -czf /tmp/fullstack-build/fullstack.tar.gz .
          cp /tmp/fullstack-build/fullstack.tar.gz .

      - name: 🚚 Copy code to EC2 instance
        run: scp fullstack.tar.gz ubuntu@${{ secrets.PUBLIC_INSTANCE_IP }}:/tmp/

      - name: 🚀 Deploy on EC2
        run: |
          ssh ubuntu@${{ secrets.PUBLIC_INSTANCE_IP }} 'bash -s' <<'EOF'
            set -e
            echo "🚀 Deployment started at $(date -u)"

            # === Cleanup and Setup ===
            sudo rm -rf /opt/user /opt/employee
            sudo mkdir -p /opt/user /opt/employee
            sudo chown -R ubuntu:ubuntu /opt

            # === Extract Code ===
            cd /opt
            cp /tmp/fullstack.tar.gz .
            tar xzf fullstack.tar.gz

            # === Install PM2 if not already ===
            if ! command -v pm2 &> /dev/null; then
              echo "📦 Installing PM2..."
              sudo npm install -g pm2
            fi

            # === Set Ownership ===
            sudo chown -R user:user /opt/user
            sudo chown -R employee:employee /opt/employee

            # === Start User App ===
            sudo -u user pm2 start /opt/user/ecosystem.user.config.js
            sudo -u user pm2 save

            # === Start Employee App ===
            sudo -u employee pm2 start /opt/employee/ecosystem.employee.config.js
            sudo -u employee pm2 save

            # === Enable PM2 Startup ===
            sudo pm2 startup systemd -u user --hp /home/user
            sudo pm2 startup systemd -u employee --hp /home/employee

            echo "✅ Deployment finished at $(date -u)"
          EOF
