name: Deploy Fullstack App via SSM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ“¦ Package Code into tar.gz
        run: |
          mkdir -p /tmp/fullstack-build
          tar --exclude='.git' --exclude='fullstack.tar.gz' -czf /tmp/fullstack-build/fullstack.tar.gz .
          base64 /tmp/fullstack-build/fullstack.tar.gz > fullstack_base64.txt

      - name: ðŸš€ Send SSM Deployment Command to EC2
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --region "${{ secrets.AWS_REGION }}" \
            --comment "SSM Deployment via GitHub Actions" \
            --parameters 'commands=[
              "echo Starting SSM deploy",
              "cd /tmp",
              "echo \"${{ steps.encode.outputs.encoded }}\" | base64 -d > fullstack.tar.gz",
              "rm -rf /opt/user /opt/employee",
              "mkdir -p /opt/user /opt/employee",
              "tar -xzf /tmp/fullstack.tar.gz -C /opt",
              "npm install -g pm2 || true",
              "chown -R user:user /opt/user",
              "chown -R employee:employee /opt/employee",
              "sudo -u user pm2 start /opt/user/ecosystem.user.config.js",
              "sudo -u user pm2 save",
              "sudo -u employee pm2 start /opt/employee/ecosystem.employee.config.js",
              "sudo -u employee pm2 save",
              "pm2 startup systemd -u user --hp /home/user",
              "pm2 startup systemd -u employee --hp /home/employee"
            ]'
